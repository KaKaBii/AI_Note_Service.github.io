from openai import AzureOpenAI
import sqlite3
import json
import re
import os

def GPT_classification(DATABASE_PATH="database.db", sql_command="SELECT name, content FROM transcripts ORDER BY timestamp DESC LIMIT 1"):
    api_version = "2024-02-15-preview"

    # gets the API Key from environment variable AZURE_OPENAI_API_KEY
    current_dir = os.getcwd()
    key_file_path = os.path.join(current_dir, 'gpt_key.txt')
    if not os.path.exists(key_file_path):
        raise FileNotFoundError(f"檔案 '{key_file_path}' 不存在，請檢查檔案路徑或內容！")

    with open(key_file_path, 'r') as file:
        api_key = file.read().strip()
        if api_key == "" or None:
            raise FileNotFoundError(f"金鑰為空！")
    client = AzureOpenAI(
        api_version=api_version,
        api_key=api_key,
        # https://learn.microsoft.com/en-us/azure/cognitive-services/openai/how-to/create-resource?pivots=web-portal#create-a-resource
        azure_endpoint="https://aidesign.openai.azure.com/",
    )
    messages = [
        {
            "role": "system",
            "content": [
                {
                    "type": "text",
                    "text": "**提示詞：**  \n   \n請依照以下規則將給定的對話內容進行分類，並生成一份分類文檔。分類包括四大類別：身、心、社會和其他。請確保對話的連貫性，不跳過任何一句話，並使用分隔號分開不同段落。  \n   \n**分類規則：**  \n   \n1. **身**：  \n    - 包括食慾、身體健康（如膝蓋痛、腰痛、行動不便、覺得冷等）、睡眠安穩的情形。  \n    - 例如：  \n        - 陳小姐: 呂伯伯，早上好！沒想到這麼早就能在食堂遇見您。  \n        - 呂伯伯: 早啊，陳小姐！今天起得早，想來這裡吃個豐盛的早餐。  \n   \n2. **心**：  \n    - 包括情緒方面（如憂鬱、開心、心智狀況等）。  \n    - 例如：  \n        - 呂小姐：「是啊，身體的變化我們要多注意。對了，最近心情怎麼樣？有沒有覺得比較輕鬆一點？」  \n        - 張太太：「還可以啦，不過有時候會想起以前的事情，心裡難免有點感慨。前幾天夢到我老伴，醒來後心裡空空的，覺得有點孤單。」  \n   \n3. **社會**：  \n    - 包括老人的社交、社區舉辦的活動、家人探望、和朋友的互動、打電話等。  \n    - 例如：  \n        - 社工（小張）： 這樣很好呢，適當的運動對身體很有幫助。上次您提到想和家人一起去公園，聽說他們前幾天來看您了，怎麼樣，有沒有一起出去走走？  \n        - 劉伯伯： 有的，他們帶我去附近的公園轉了一圈，還在那邊的小茶館喝了茶，聊了好多事情，真開心。  \n   \n4. **其他**：  \n    - 若對話中有不屬於“身”、“心”、“社會”三大分類的對話則歸類在此。  \n    - 例如：  \n        - 陳小姐: 哇，整理老照片一定勾起了很多回憶吧！有沒有什麼特別有趣的故事可以分享？  \n        - 呂伯伯: 是啊，看到年輕時候的照片，想起了很多有趣的事情。有一張是我們一起去爬山，那次我們還迷了路，結果在山上過了一夜。  \n   \n**注意事項：**  \n- 確保每段對話只在一個分類中出現。  \n- 保持對話的連貫性，不跳過任何一句話。  \n- 使用分隔號（——）分開不同段落。  \n   \n**範例：**  \n   \n**身:**  \n陳小姐: 呂伯伯，早上好！沒想到這麼早就能在食堂遇見您。  \n呂伯伯: 早啊，陳小姐！今天起得早，想來這裡吃個豐盛的早餐。  \n陳小姐: 看來您的胃口不錯呀！今天早餐有什麼特別想吃的嗎？  \n呂伯伯: 我看到有粥和包子，就拿了一些。早上吃點熱的，感覺整個人都暖和起來了。  \n陳小姐: 是啊，早上的粥最能暖胃了。  \n呂伯伯: 是啊，心情好，吃飯也香。今天的包子特別好吃，你也試試吧。  \n   \n**心:**  \n陳小姐: 對了，呂伯伯，您最近心情怎麼樣？  \n呂伯伯: 最近心情還不錯，只是昨天接到一個老朋友的電話，聊起了一些往事，心裡有些感慨。  \n——  \n陳小姐: 那真是太好了。保持這種心情，對身體和生活都有很大的幫助呢。  \n   \n**社會:**  \n陳小姐: 原來如此，老朋友的聯繫總是讓人感觸良多。是什麼樣的往事呢？  \n呂伯伯: 我們聊到了以前一起工作的時候，想起那時候一起努力的日子，真是懷念啊。也有點感慨時間過得真快。  \n陳小姐: 是啊，回憶總是美好的。能夠和老朋友敘舊，也是很珍貴的事情呢。  \n呂伯伯: 沒錯，聊完之後，我也覺得心裡暖暖的，像是重新找回了一些年輕時的熱情。  \n   \n**其他:**  \n陳小姐: 好的，我也去拿一個嘗嘢。希望您今天也有個愉快的開始！  \n呂伯伯: 謝謝你，陳小姐。希望你今天也順順利利的！我們等會兒再聊。  \n陳小姐: 好的，呂伯伯，等會兒見！  \n\n最後將結果轉為Json格式。"
                }
            ]
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "2024/11/23/11:25-食堂"
                },
                {
                    "type": "text",
                    "text": "呂小姐：方太太，您好！今天怎麼沒看到您吃早餐呢？"
                },
                {
                    "type": "text",
                    "text": "方太太：呂小姐，早安。我今天早上有點不舒服，肚子一直咕嚕咕嚕的，感覺有點拉肚子，所以沒什麼食慾。"
                },
                {
                    "type": "text",
                    "text": "呂小姐：哦，那可不太好。您昨天吃了什麼特別的東西嗎？"
                },
                {
                    "type": "text",
                    "text": "方太太：也沒什麼特別的，就是平常的三餐。可能是昨晚的魚湯有點不太合胃口吧。"
                },
                {
                    "type": "text",
                    "text": "呂小姐：了解。今天先喝點溫開水，讓胃腸休息一下。我們這裡的護士可以幫您檢查一下，看看是不是需要吃點藥。"
                },
                {
                    "type": "text",
                    "text": "方太太：好，謝謝你。這樣的話，我就麻煩護士了。"
                },
                {
                    "type": "text",
                    "text": "呂小姐：不麻煩，這是我們應該做的。方太太，您最近心情還好嗎？有沒有什麼需要我幫忙的？"
                },
                {
                    "type": "text",
                    "text": "方太太：心情還好，就是這幾天胃口不好，心裡有點煩。希望快點好起來，這樣就能參加週末的手工藝活動了。"
                },
                {
                    "type": "text",
                    "text": "呂小姐：我明白，生病總是讓人心情不太好。不過，您平時心情都很開朗，相信很快就會好起來的。這幾天我會多來看看您，有需要隨時告訴我。"
                },
                {
                    "type": "text",
                    "text": "方太太：謝謝你，呂小姐。你的關心讓我覺得好多了。"
                },
                {
                    "type": "text",
                    "text": "呂小姐：不客氣，方太太。您一定要多休息，有什麼問題隨時找我或護士。"
                },
                {
                    "type": "text",
                    "text": "方太太：好的，謝謝你。"
                },
                {
                    "type": "text",
                    "text": "\n"
                }
            ]
        },
        {
            "role": "assistant",
            "content": [
                {
                    "type": "text",
                    "text": "```json\n{\n  \"身\": [\n    {\n      \"呂小姐１\": \"方太太，您好！今天怎麼沒看到您吃早餐呢？\",\n      \"方太太１\": \"呂小姐，早安。我今天早上有點不舒服，肚子一直咕嚕咕嚕的，感覺有點拉肚子，所以沒什麼食慾。\",\n      \"呂小姐２\": \"哦，那可不太好。您昨天吃了什麼特別的東西嗎？\",\n      \"方太太２\": \"也沒什麼特別的，就是平常的三餐。可能是昨晚的魚湯有點不太合胃口吧。\",\n      \"呂小姐３\": \"了解。今天先喝點溫開水，讓胃腸休息一下。我們這裡的護士可以幫您檢查一下，看看是不是需要吃點藥。\",\n      \"方太太３\": \"好，謝謝你。這樣的話，我就麻煩護士了。\",\n      \"呂小姐４\": \"不麻煩，這是我們應該做的。\"\n    }\n  ],\n  \"心\": [\n    {\n      \"呂小姐１\": \"方太太，您最近心情還好嗎？有沒有什麼需要我幫忙的？\",\n      \"方太太１\": \"心情還好，就是這幾天胃口不好，心裡有點煩。希望快點好起來，這樣就能參加週末的手工藝活動了。\",\n      \"呂小姐２\": \"我明白，生病總是讓人心情不太好。不過，您平時心情都很開朗，相信很快就會好起來的。這幾天我會多來看看您，有需要隨時告訴我。\",\n      \"方太太２\": \"謝謝你，呂小姐。你的關心讓我覺得好多了。\",\n      \"呂小姐３\": \"不客氣，方太太。您一定要多休息，有什麼問題隨時找我或護士。\",\n      \"方太太３\": \"好的，謝謝你。\"\n    }\n  ],\n  \"社會\": [],\n  \"其他\": []\n}\n```"
                }
            ]
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "2024/12/15/15:33-社區大樓外"
                },
                {
                    "type": "text",
                    "text": "社工（小張）： 劉伯伯，下午好！最近天氣變冷了，您還好嗎？好一陣子沒見到您了。"
                },
                {
                    "type": "text",
                    "text": "劉伯伯：小張，下午好！我還好，就是最近天氣冷，有點懶得出門。"
                },
                {
                    "type": "text",
                    "text": "社工（小張）：這種天氣確實讓人想待在室內。您在房間裡有好好保暖嗎？我們這邊的暖氣還夠不夠？"
                },
                {
                    "type": "text",
                    "text": "劉伯伯：暖氣還行，房間裡挺暖和的。就是有時候覺得外面風大，懶得走出去。"
                },
                {
                    "type": "text",
                    "text": "社工（小張）：嗯，這樣的天氣確實讓人不太想出門。不過如果您想活動一下，我們可以安排一些室內的活動，比如說看電影或者做點手工，您覺得怎麼樣？"
                },
                {
                    "type": "text",
                    "text": "劉伯伯：這主意不錯，我最近正想找點事情做呢。"
                },
                {
                    "type": "text",
                    "text": "社工（小張）：太好了，我們可以安排一些有趣的活動，讓大家一起參與。對了，之前有提到您想看的那部老電影，您想起來名字了嗎？"
                },
                {
                    "type": "text",
                    "text": "劉伯伯：想起來了，是那部《城南舊事》。我一直很喜歡那部電影的故事。"
                },
                {
                    "type": "text",
                    "text": "社工（小張）：好的，我們可以安排放映這部電影，讓您重溫一下。最近有沒有跟家裡聯絡呢？"
                },
                {
                    "type": "text",
                    "text": "劉伯伯： 最近還好，大家都忙，我也不想打擾他們。"
                },
                {
                    "type": "text",
                    "text": "社工（小張）：我理解，有時候大家各自忙碌，不過如果您想念他們，隨時可以給他們打電話，或者我們可以幫您安排視頻通話。"
                },
                {
                    "type": "text",
                    "text": "劉伯伯：好的，我考慮一下。謝謝你，小張。"
                },
                {
                    "type": "text",
                    "text": "社工（小張）：不客氣，劉伯伯。我們會一直在這裡支持您，有什麼需要隨時告訴我哦。"
                },
                {
                    "type": "text",
                    "text": "\n"
                }
            ]
        },
        {
            "role": "assistant",
            "content": [
                {
                    "type": "text",
                    "text": "```json\n{\n  \"身\": [\n    {\n      \"社工（小張）１\": \"劉伯伯，下午好！最近天氣變冷了，您還好嗎？好一陣子沒見到您了。\",\n      \"劉伯伯１\": \"小張，下午好！我還好，就是最近天氣冷，有點懶得出門。\",\n      \"社工（小張）２\": \"這種天氣確實讓人想待在室內。您在房間裡有好好保暖嗎？我們這邊的暖氣還夠不夠？\",\n      \"劉伯伯２\": \"暖氣還行，房間裡挺暖和的。就是有時候覺得外面風大，懶得走出去。\"\n    }\n  ],\n  \"心\": [],\n  \"社會\": [\n    {\n      \"社工（小張）１\": \"嗯，這樣的天氣確實讓人不太想出門。不過如果您想活動一下，我們可以安排一些室內的活動，比如說看電影或者做點手工，您覺得怎麼樣？\",\n      \"劉伯伯１\": \"這主意不錯，我最近正想找點事情做呢。\",\n      \"社工（小張）２\": \"太好了，我們可以安排一些有趣的活動，讓大家一起參與。對了，之前有提到您想看的那部老電影，您想起來名字了嗎？\",\n      \"劉伯伯２\": \"想起來了，是那部《城南舊事》。我一直很喜歡那部電影的故事。\",\n      \"社工（小張）３\": \"好的，我們可以安排放映這部電影，讓您重溫一下。最近有沒有跟家裡聯絡呢？\",\n      \"劉伯伯３\": \"最近還好，大家都忙，我也不想打擾他們。\",\n      \"社工（小張）４\": \"我理解，有時候大家各自忙碌，不過如果您想念他們，隨時可以給他們打電話，或者我們可以幫您安排視頻通話。\",\n      \"劉伯伯４\": \"好的，我考慮一下。謝謝你，小張。\",\n      \"社工（小張）５\": \"不客氣，劉伯伯。我們會一直在這裡支持您，有什麼需要隨時告訴我哦。\"\n    }\n  ],\n  \"其他\": []\n}\n```"
                }
            ]
        }
    ]
    rows = ""
    try:
        conn = sqlite3.connect(DATABASE_PATH)
        cursor = conn.cursor()
        cursor.execute(sql_command)
        rows = cursor.fetchall()[0]
        conn.commit()
        conn.close()
    except Exception as e: print(e)
    f = rows[1].split("\n")
    for prompt in f:
        messages.append({
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": prompt,
                }
            ],
        })
    completion = client.chat.completions.create(
        model="AI_Design_Pro",  # e.g. gpt-35-instant
        messages=messages,
        temperature=0.7,
        top_p=0.95,
        max_tokens=1200
    )
    print("GPT classification successful")
    return rows[0], json.loads(re.split("json\n", re.split("```", completion.choices[0].message.content)[1])[1])